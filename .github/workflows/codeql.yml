name: GHAS with HTML Report

on:
  workflow_dispatch:  # Manual trigger

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: macos-latest  # For Swift projects, adjust if needed
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: html,javascript,pug,scss,solidity,typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: sarif-results
          category: '/language:multi'

      - name: Generate Combined HTML Report
        run: |
          echo "üìÑ Generating combined GHAS HTML report..."

          SARIF_FILE=$(find sarif-results -name "*.sarif" | head -n 1)

          {
            echo "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>GHAS Combined Report</title>"
            echo "<style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1, h2, h3 { color: #2c3e50; }
              pre { background: #f4f4f4; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
              .issue { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
            </style></head><body>"

            echo "<h1>üîç GHAS Executive Summary (All Languages)</h1>"

            FILE_COUNT=$(find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.html" -o -name "*.scss" -o -name "*.sol" -o -name "*.pug" \) | wc -l || echo 0)
            LINE_COUNT=$(find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.html" -o -name "*.scss" -o -name "*.sol" -o -name "*.pug" \) -exec cat {} + | wc -l || echo 0)
            ISSUE_COUNT=$(jq '[.runs[].results[]] | length' "$SARIF_FILE" || echo 0)

            echo "<ul>"
            echo "<li><strong>Source Files:</strong> $FILE_COUNT</li>"
            echo "<li><strong>Total Lines:</strong> $LINE_COUNT</li>"
            echo "<li><strong>Total Issues:</strong> $ISSUE_COUNT</li>"
            echo "</ul>"

            echo "<h2>üìä Issue Category Breakdown</h2><ul>"
            jq -r '.runs[].results[]?.ruleId' "$SARIF_FILE" | sort | uniq -c | sort -nr | \
              awk '{ print "<li>" $2 ": " $1 " issues</li>" }'
            echo "</ul>"

            echo "<h2>üßæ Detailed Findings</h2>"
            jq -r '
              .runs[].results[] |
              [
                .ruleId,
                .message.text,
                .locations[0].physicalLocation.artifactLocation.uri,
                .locations[0].physicalLocation.region.startLine,
                .locations[0].physicalLocation.region.snippet.text // "No snippet available",
                .partialFingerprints.explanation // "No explanation provided",
                .partialFingerprints.remediation // "No remediation provided"
              ] |
              @tsv
            ' "$SARIF_FILE" | while IFS=$'\t' read -r ruleId message file line snippet explanation remediation; do
                # Escape and format line breaks
                message=$(echo "$message" | sed 's/\\n/<br>/g')
                snippet=$(echo "$snippet" | sed 's/\\n/<br>/g')
                explanation=$(echo "$explanation" | sed 's/\\n/<br>/g')
                remediation=$(echo "$remediation" | sed 's/\\n/<br>/g')

                echo "<div class='issue'>"
                echo "<h3>üîπ Rule: $ruleId</h3>"
                echo "<p><strong>File:</strong> $file:$line</p>"
                echo "<p><strong>Finding:</strong> $message</p>"
                echo "<p><strong>Code Snippet:</strong></p><pre>${snippet}</pre>"
                echo "<p><strong>Explanation:</strong> $explanation</p>"
                echo "<p><strong>Remediation:</strong> $remediation</p>"
                echo "</div>"
            done

            echo "</body></html>"
          } > ghas-combined-report.html

      - name: Upload Combined HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: GHAS-Combined-Report
          path: ghas-combined-report.html
