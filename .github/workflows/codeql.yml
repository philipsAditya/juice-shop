name: GHAS with HTML Report

on:
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List languages and build matrix
        id: set-matrix
        run: |
          mkdir out
          echo '{}' > out/combined.json
          langs=$(gh api repos/${{ github.repository }}/code-scanning/languages | jq -rc 'keys')
          echo "Languages: $langs"
          echo "matrix={\"lang\":$langs}" >> $GITHUB_OUTPUT

  run-codeql:
    needs: scan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.scan.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.lang }}
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Run CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          output: results
          format: sarif

      - name: Process SARIF
        shell: bash
        run: |
          mkdir -p out
          LANG="${{ matrix.lang }}"
          SARIF_FILE="results/${LANG}.sarif"
          jq -r --arg lang "$LANG" '
            {
              language: $lang,
              supported: (.runs[0].results != null),
              fileCount: (.runs[0].artifacts | length),
              lineCount: (.runs[0].results | map(.locations[].physicalLocation.region.endLine // 0) | add),
              issues: (.runs[0].results | map({
                message: .message.text,
                severity: .rule.severity // "warning",
                file: .locations[0].physicalLocation.artifactLocation.uri,
                line: .locations[0].physicalLocation.region.startLine
              }))
            }
          ' "$SARIF_FILE" > "out/$LANG.json"

      - name: Upload JSON
        uses: actions/upload-artifact@v4
        with:
          name: partial-ghas-json
          path: out/*.json

  combine:
    needs: run-codeql
    runs-on: ubuntu-latest
    steps:
      - name: Download all partial JSONs
        uses: actions/download-artifact@v4
        with:
          name: partial-ghas-json
          path: out

      - name: Combine all JSONs
        run: |
          jq -s '.' out/*.json > final-ghas.json

      - name: Upload combined JSON
        uses: actions/upload-artifact@v4
        with:
          name: final-ghas-json
          path: final-ghas.json

  generate-html:
    needs: combine
    runs-on: ubuntu-latest
    steps:
      - name: Download combined JSON
        uses: actions/download-artifact@v4
        with:
          name: final-ghas-json

      - name: Generate HTML
        run: |
          JSON="final-ghas.json"
          HTML="ghas-report.html"

          {
            echo "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>GHAS Combined Report</title>"
            echo "<style>
              body { font-family: Arial; padding: 20px; max-width: 1200px; margin: 0 auto; }
              h1, h2, h3 { color: #2c3e50; }
              pre { background: #f4f4f4; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
              .issue { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; }
              .summary-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              .summary-table th, .summary-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              .summary-table th { background-color: #f2f2f2; }
              .summary-table tr:nth-child(even) { background-color: #f9f9f9; }
              .warning { color: #f39c12; }
              .danger { color: #e74c3c; }
              .safe { color: #27ae60; }
              .summary-card { margin-bottom: 30px; padding: 15px; border-radius: 5px; background-color: #f8f9fa; border: 1px solid #e9ecef; }
              .language-section { margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px; }
            </style></head><body>"

            echo "<h1>üîç GHAS Consolidated Report</h1>"

            echo "<div class='summary-card'>"
            echo "<h2>üìä Summary</h2>"
            echo "<table class='summary-table'>"
            echo "<tr><th>Language</th><th>Files Scanned</th><th>Lines Scanned</th><th>Issues Found</th><th>Status</th></tr>"

            totalIssues=0
            totalFiles=0
            totalLines=0
            
            jq -c '.[]' "$JSON" | while read -r entry; do
              lang=$(echo "$entry" | jq -r '.language')
              fcount=$(echo "$entry" | jq -r '.fileCount')
              lcount=$(echo "$entry" | jq -r '.lineCount')
              supported=$(echo "$entry" | jq -r '.supported')
              icount=$(echo "$entry" | jq -r '.issues | length')
              
              totalFiles=$((totalFiles + fcount))
              totalLines=$((totalLines + lcount))
              totalIssues=$((totalIssues + icount))
              
              statusClass="safe"
              statusText="No Issues"
              
              if [ "$supported" != "true" ]; then
                statusClass="warning"
                statusText="Not Supported"
              elif [ "$icount" -gt 0 ]; then
                statusClass="danger"
                statusText="Issues Found"
              fi
              
              echo "<tr><td><strong>$lang</strong></td><td>$fcount</td><td>$lcount</td><td class='$statusClass'><strong>$icount</strong></td><td class='$statusClass'>$statusText</td></tr>"
            done
            
            echo "<tr style='font-weight: bold; background-color: #e9ecef;'><td>TOTAL</td><td>$totalFiles</td><td>$totalLines</td><td>$totalIssues</td><td></td></tr>"
            echo "</table>"
            echo "</div>"

            echo "<hr>"
            echo "<footer><p>Generated on $(date)</p></footer>"
            echo "</body></html>"
          } > $HTML

      - name: Upload HTML
        uses: actions/upload-artifact@v4
        with:
          name: ghas-html-report
          path: ghas-report.html
